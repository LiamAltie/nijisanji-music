jobs:
  deploy-sanity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Slack Notification Vars
        id: prep_vars
        run: |
          echo "WORKFLOW_NAME='${{ github.workflow }}'" >> $GITHUB_ENV
          echo "REPOSITORY='${{ github.repository }}'" >> $GITHUB_ENV
          echo "REF_NAME='${{ github.ref_name }}'" >> $GITHUB_ENV
          echo "ACTOR='${{ github.actor }}'" >> $GITHUB_ENV
          echo "EVENT_NAME='${{ github.event_name }}'" >> $GITHUB_ENV
          echo "RUN_URL='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'" >> $GITHUB_ENV
          # Add any other variables needed in your templates

      - name: Generate Slack Start Payload
        id: slack_payload_start
        run: |
          # envsubstで置換し、jq -c でJSONを検証＆コンパクト化
          JSON_PAYLOAD=$(envsubst < .github/slack/start-payload.template.json | jq -c .)

          # デバッグ用に生成されたJSONをログに出力 (オプション)
          echo "Generated JSON: $JSON_PAYLOAD" 

          # 結果をoutputsに設定
          echo "payload=$JSON_PAYLOAD" >> $GITHUB_OUTPUT

      - name: Notify Slack - Workflow Started
        if: always()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: ${{ steps.slack_payload_start.outputs.payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Generate Slack Success Payload
        id: slack_payload_success
        if: success()
        run: |
          JSON_PAYLOAD=$(envsubst < .github/slack/success-payload.template.json | jq -c .)
          echo "payload=$JSON_PAYLOAD" >> $GITHUB_OUTPUT

      - name: Notify Slack - Success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: ${{ steps.slack_payload_success.outputs.payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Generate Slack Failure Payload
        id: slack_payload_failure
        if: failure()
        run: |
          JSON_PAYLOAD=$(envsubst < .github/slack/failure-payload.template.json | jq -c .)
          echo "payload=$JSON_PAYLOAD" >> $GITHUB_OUTPUT

      - name: Notify Slack - Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: ${{ steps.slack_payload_failure.outputs.payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
